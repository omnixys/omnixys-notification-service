generator client {
  provider = "prisma-client"
  output   = "../src/prisma/generated"
}

datasource db {
  provider = "postgresql"
  schemas  = ["notification"]
}

//
// ──────────────────────────────────────────────────────────
// ENUMS
// ──────────────────────────────────────────────────────────
//

enum Channel {
  IN_APP
  PUSH
  EMAIL
  SMS
  WHATSAPP

  @@map("channel")
  @@schema("notification")
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT

  @@map("priority")
  @@schema("notification")
}

enum NotificationStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  EXPIRED
  ARCHIVED

  @@map("notification_status")
  @@schema("notification")
}

enum DeliveryAttemptStatus {
  SUCCESS
  FAILED

  @@map("delivery_attempt_status")
  @@schema("notification")
}

enum Category {
  WHATSAPP
  INFO
  WARNING

  @@map("category")
  @@schema("notification")
}

//
// ──────────────────────────────────────────────────────────
// TEMPLATE
// ──────────────────────────────────────────────────────────
//

model Template {
  id String @id @default(cuid()) @map("id")

  /// Logical template key (e.g. account.welcome.credentials)
  key String @map("key")

  /// Optional subject/title (EMAIL, PUSH, IN_APP)
  title String? @map("title")

  /// Body with placeholders (e.g. {{username}})
  body String @map("body")

  /// JSON placeholder definition & validation rules
  variables Json @default("{}") @map("variables")

  /// Locale (de-DE, en-US)
  locale String @default("de-DE") @map("locale")

  /// Delivery channel
  channel Channel @map("channel")

  /// Functional grouping (ACCOUNT, SECURITY, INFO, ...)
  category String? @map("category")

  isActive Boolean @default(true) @map("is_active")
  version  Int     @default(1) @map("version")

  tags String[] @default([]) @map("tags")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  notifications Notification[]

  @@unique([key, channel, locale, version])
  @@map("template")
  @@schema("notification")
}

//
// ──────────────────────────────────────────────────────────
// NOTIFICATION INSTANCE
// ──────────────────────────────────────────────────────────
//

model Notification {
  id String @id @default(cuid()) @map("id")

  // ── Recipient ───────────────────────────────────────────
  recipientUsername String  @map("recipient_username")
  recipientId       String? @map("recipient_id")
  recipientTenant   String? @map("recipient_tenant")

  // ── Template & Rendering ─────────────────────────────────
  templateId String?   @map("template_id")
  template   Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  /// Original input variables
  variables Json @default("{}") @map("variables")

  /// Rendered content
  renderedTitle String? @map("rendered_title")
  renderedBody  String  @map("rendered_body")

  /// Extra structured payload (buttons, deeplinks)
  data    Json    @default("{}") @map("data")
  linkUrl String? @map("link_url")

  channel  Channel  @map("channel")
  priority Priority @default(NORMAL) @map("priority")
  category String?  @map("category")

  // ── Lifecycle ────────────────────────────────────────────
  status      NotificationStatus @default(PENDING) @map("status")
  errorReason String?            @map("error_reason")

  read        Boolean   @default(false) @map("read")
  deliveredAt DateTime? @map("delivered_at")
  readAt      DateTime? @map("read_at")
  archivedAt  DateTime? @map("archived_at")
  expiresAt   DateTime? @map("expires_at")

  /// Marks notifications containing secrets
  sensitive Boolean @default(false) @map("sensitive")

  // ── Audit ────────────────────────────────────────────────
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")

  /// Idempotency key (Kafka-safe)
  dedupeKey String? @unique @map("dedupe_key")

  deliveryAttempts DeliveryAttempt[]

  @@index([recipientUsername, read, createdAt])
  @@index([recipientUsername, status, createdAt])
  @@index([templateId])
  @@index([expiresAt])
  @@map("notification")
  @@schema("notification")
}

//
// ──────────────────────────────────────────────────────────
// DELIVERY ATTEMPTS
// ──────────────────────────────────────────────────────────
//

model DeliveryAttempt {
  id String @id @default(cuid()) @map("id")

  notificationId String       @map("notification_id")
  notification   Notification @relation(fields: [notificationId], references: [id])

  attemptNumber Int    @map("attempt_number")
  provider      String @map("provider")

  status       DeliveryAttemptStatus @map("status")
  errorMessage String?               @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([notificationId, attemptNumber])
  @@map("delivery_attempt")
  @@schema("notification")
}
